#!/bin/sh
#mnt
# mount removable drives and cd into it

# lets make it nicer by being interactive
log="$HOME/.local/share/mnt.log"

# check whether dmenu is present, if not check for fzf, else exit
if ! command -v dmenu > /dev/null 2>&1; then
	if command -v fzf > /dev/null 2>&1; then
	chooser="fzf"
	else
		/usr/bin/notify-send "Error!" "Install dmenu or fzf to proceed"
		exit 1
	fi
else
	chooser="dmenu"
fi

# get list of drives attached
drive="$(/usr/bin/lsblk -anlp -o +LABEL | \
        /usr/bin/grep -vE "nvme|backup" | \
        /usr/bin/grep part | \
        /usr/bin/cut -d ' ' -f 1)"

# if no removable drive attached, exit gracefully
if [ -z "$drive" ]; then
    /usr/bin/notify-send "No drives attached" "Nothing to mount"
    exit 1
fi

# select removable drive to mount
if [ "$chooser" = "dmenu" ]; then
    selected="$(/usr/bin/printf "%s\n" "$drive" | \
        dmenu -p "choose device to mount: ")"
else
    selected="$(/usr/bin/printf "%s\n" "$drive" | \
        fzf --prompt="choose device to mount: ")"
fi

# mount drive as per its label, else use device number (default)
lbl="$(/usr/bin/lsblk -nl -o +LABEL | \
    /usr/bin/grep "$selected" | \
    /usr/bin/sed 's@\ \ *@\ @g' | \
    /usr/bin/cut -d ' ' -f 7)"
dnum="$(/usr/bin/lsblk -nl | \
    /usr/bin/grep "$selected" | \
    /usr/bin/cut -d ' ' -f 1)"

# check whether selected drive is already mounted, else mount it and cd into it
if [ -n "$(/usr/bin/findmnt "$selected")" ]; then
    /usr/bin/notify-send "$selected already mounted" "Nothing to mount"
    exit 1
else
    if [ -z "$lbl" ]; then
        if ! /usr/bin/pmount "$selected" 2>> "$log"; then
            /usr/bin/notify-send "$selected couldnot be mounted" "Check logfile for details"
            exit 1
        else
            /usr/bin/notify-send "$selected successfully mounted" "at /media/$dnum"
            cd /media/"$dnum" || exit 1
        fi
    else
        if ! /usr/bin/pmount "$selected" "$lbl" 2>> "$log"; then
            /usr/bin/notify-send "$selected couldnot be mounted" "Check logfile for details"
            exit 1
        else
            /usr/bin/notify-send "$selected successfully mounted" "at /media/$lbl"
            cd /media/"$lbl" || exit 1
        fi
    fi
fi

$SHELL
