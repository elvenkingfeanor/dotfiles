#!/bin/sh
#bakp
# find removable backup media, mount it, backup to it and unmount it

time="$(/usr/bin/date +%H)"
logfile="$HOME/.local/share/bakp.log"

# list of backup drives attached
# (excludes internal NVME drives)
bdrive="$(/usr/bin/lsblk -anlp -o +LABEL | \
    /usr/bin/grep -v nvme | \
    /usr/bin/grep backup | \
    /usr/bin/cut -d ' ' -f 1)"

# abort if no backup drive attached
if [ -z "$bdrive" ]; then
    /usr/bin/notify-send "No backup drive attached" "Aborting..."
    /usr/bin/printf "%s\n" "backup for $(/usr/bin/date '+%A %F') aborted at $(/usr/bin/date +%H%M)hrs, no device found" >> "$logfile"
    exit 1
fi

# if only the 1 backup drive attached, skip selection and proceed
# automatic selection criteria:
# 1. if no destination backup directory present, then total partition space should be more than 1 TB (1099511627776 bytes)
# 1a. to check whether backup directory is present, need to mount first
# 2. if destination backup directory present, then free disk space should be more than 1 GB (1073741824 bytes)
# 2a. same as 1a.
# 3. if multiple backup drives have backup directory present, then most-recently backed up backup location gets precedence
# 3a. same as 1a.
# 3b. blob for specifying backup directory in multiple backup drives
if [ "$(/usr/bin/printf "%s\n" "$bdrive" | \
    /usr/bin/wc -l)" -eq 1 ]; then
    selected="$bdrive"
fi

# whether backup drive is mounted
bmounted="$(/usr/bin/findmnt "$selected")"

# label of backup drive, for use by pmount to mount
# space-separated drive LABEL NAMES maynot work
blbl="$(/usr/bin/lsblk -anlp -o +LABEL | \
    /usr/bin/grep "$selected" | \
    /usr/bin/sed 's@^.*\ @@g')"

# if backup for today already done, abort, if not continue
# backup often takes hours, stop script from re-running if another instance of rsync is present
# backup often takes hours, stop script if it is outside specified time range for given day
if /usr/bin/grep -Eq "$(/usr/bin/date '+%A %F').completed" "$logfile"; then
   /usr/bin/notify-send "Backup for today done" "Aborting..."
   /usr/bin/printf "%s\n" "backup for $(/usr/bin/date '+%A %F') aborted at $(/usr/bin/date +%H%M)hrs, already done" >> "$logfile"
   exit 1
elif [ -n "$bmounted" ] && [ -n "$(/usr/bin/pgrep rsync)" ]; then
    /usr/bin/notify-send "Backup in progress" "Exiting..."
    /usr/bin/printf "%s\n" "backup for $(/usr/bin/date '+%A %F') aborted at $(/usr/bin/date +%H%M)hrs, backup in progress" >> "$logfile"
    exit 1
elif [ "$time" -ge 9 ] && [ "$time" -lt 19 ]; then
    if [ -z "$bmounted" ]; then
        /usr/bin/notify-send "Backup starting shortly" "Mounting external backup drive"
        /usr/bin/pmount "$bdrive" "$blbl"
        /usr/bin/notify-send "Backup started" "No backup for today found"
        /usr/bin/printf "%s\n" "backup for $(/usr/bin/date '+%A %F') started at $(/usr/bin/date +%H%M)hrs" >> "$logfile"
        /usr/bin/pkill -RTMIN+14 -f /usr/local/bin/dwmblocks
    else
        /usr/bin/notify-send "Backup started" "No backup for today found"
        /usr/bin/printf "%s\n" "backup for $(/usr/bin/date '+%A %F') started at $(/usr/bin/date +%H%M)hrs" >> "$logfile"
        /usr/bin/pkill -RTMIN+14 -f /usr/local/bin/dwmblocks
    fi
else /usr/bin/notify-send "Aborting" "Try again later"
     /usr/bin/printf "%s\n" "backup for $(/usr/bin/date '+%A %F') aborted at $(/usr/bin/date +%H%M)hrs, out of time" >> "$logfile"
     exit 1
fi

# start syncing to backup and back, logging each individual rsync errors to logfile
# /usr/bin/rsync --verbose --itemize-changes --archive --checksum -hh --partial --progress --info=stats1 --recursive --modify-window=1 ~/.bak/crypt-bak/ -t /media/backup/ts-bak/bak/crypt-bak && /usr/bin/rsync --verbose --itemize-changes --archive --checksum -hh --partial --progress --info=stats1 --recursive --modify-window=1 /media/backup/ts-bak/bak/crypt-bak/ -t ~/.bak/crypt-bak; # keeping line for old arguments
/usr/bin/notify-send "secret backup started"

if ! /usr/bin/rsync --archive --checksum --partial --recursive ~/.bak/crypt-bak/ \
 -t /media/backup/ts-bak/bak/crypt-bak \
 2>> "$logfile" \
    && /usr/bin/rsync --archive --checksum --partial --recursive /media/backup/ts-bak/bak/crypt-bak/ \
 -t ~/.bak/crypt-bak \
 2>> "$logfile"; then
    /usr/bin/notify-send "secret backup failed" "check error log"
    /usr/bin/printf "%s\n" "secret backup for $(/usr/bin/date '+%A %F') failed at $(/usr/bin/date +%H%M)hrs" >> "$logfile"
else
    /usr/bin/notify-send "secret backup done"
fi

/usr/bin/notify-send "etc backup started"
if ! /usr/bin/rsync --archive --checksum --partial --recursive ~/.bak/etc-bak/ \
 -t /media/backup/ts-bak/bak/etc-bak \
 2>> "$logfile" \
    && /usr/bin/rsync --archive --checksum --partial --recursive /media/backup/ts-bak/bak/etc-bak/ \
 -t ~/.bak/etc-bak \
 2>> "$logfile"; then
    /usr/bin/notify-send "etc backup failed" "check error log"
    /usr/bin/printf "%s\n" "etc backup for $(/usr/bin/date '+%A %F') failed at $(/usr/bin/date +%H%M)hrs" >> "$logfile"
else
    /usr/bin/notify-send "etc backup done"
fi

/usr/bin/notify-send "config backup started"
if ! /usr/bin/rsync --archive --checksum --partial --recursive \
    --exclude '*.o' \
    --exclude 'dmenu' \
    --exclude 'dwm' \
    --exclude 'dwmblocks' \
    --exclude 'sent' \
    --exclude 'st' \
    --exclude 'stest' \
    ~/.config/aerc \
    ~/.config/alacritty \
    ~/.config/bash \
    ~/.config/crond \
    ~/.config/doom \
    ~/.config/dunst \
    ~/.config/gallery-dl \
    ~/.config/gcompris \
    ~/.config/git \
    ~/.config/gtk-2.0 \
    ~/.config/gtk-3.0 \
    ~/.config/mpv \
    ~/.config/newsraft \
    ~/.config/npm \
    ~/.config/nsxiv \
    ~/.config/nvim \
    ~/.config/octodroid \
    ~/.config/pcmanfm \
    ~/.config/qutebrowser \
    ~/.config/readline \
    ~/.config/shell \
    ~/.config/suckless \
    ~/.config/X11 \
    ~/.config/xwallpaper \
    ~/.config/youtube-viewer \
    ~/.config/yt-dlp \
    ~/.config/zathura \
    ~/.config/zsh \
    ~/.config/mimeapps.list \
    ~/.config/rmwrc \
    ~/.config/user-dirs.dirs \
    ~/.config/user-dirs.locale \
 -t /media/backup/ts-bak/bak/conf-bak \
 2>> "$logfile" \
    && /usr/bin/rsync --archive --checksum --partial --recursive /media/backup/ts-bak/bak/conf-bak/ \
 -t ~/.config \
 2>> "$logfile"; then
    /usr/bin/notify-send "config backup failed" "check error log"
    /usr/bin/printf "%s\n" "config backup for $(/usr/bin/date '+%A %F') failed at $(/usr/bin/date +%H%M)hrs" >> "$logfile"
else
    /usr/bin/notify-send "config backup done"
fi

/usr/bin/notify-send "local/bin backup started"
if ! /usr/bin/rsync --archive --checksum --partial --recursive ~/.local/bin/ \
 -t /media/backup/ts-bak/bak/local-bak/bin \
 2>> "$logfile" \
 && /usr/bin/rsync --archive --checksum --partial --recursive /media/backup/ts-bak/bak/local-bak/bin/ \
 -t ~/.local/bin \
 2>> "$logfile"; then
    /usr/bin/notify-send "local/bin backup failed" "check error log"
    /usr/bin/printf "%s\n" "local/bin backup for $(/usr/bin/date '+%A %F') failed at $(/usr/bin/date +%H%M)hrs" >> "$logfile"
else
    /usr/bin/notify-send "local/bin backup done"
fi

/usr/bin/notify-send "local/share backup started"
if ! /usr/bin/rsync --archive --checksum --partial --recursive \
    ~/.local/share/bookmarks \
    ~/.local/share/emoji.txt \
 -t /media/backup/ts-bak/bak/local-bak/share \
 2>> "$logfile" \
 && /usr/bin/rsync --archive --checksum --partial --recursive /media/backup/ts-bak/bak/local-bak/share/ \
 -t ~/.local/share \
 2>> "$logfile"; then
    /usr/bin/notify-send "local/share backup failed" "check error log"
    /usr/bin/printf "%s\n" "local/share backup for $(/usr/bin/date '+%A %F') failed at $(/usr/bin/date +%H%M)hrs" >> "$logfile"
else
    /usr/bin/notify-send "local/share backup done"
fi

/usr/bin/notify-send "archive backup started"
if ! /usr/bin/rsync --archive --checksum --partial --recursive ~/.arx/ \
 -t /media/backup/ts-bak/arx \
 2>> "$logfile" \
 && /usr/bin/rsync --archive --checksum --partial --recursive /media/backup/ts-bak/arx/ \
 -t ~/.arx \
 2>> "$logfile"; then
    /usr/bin/notify-send "archive backup failed" "check error log"
    /usr/bin/printf "%s\n" "archive backup for $(/usr/bin/date '+%A %F') failed at $(/usr/bin/date +%H%M)hrs" >> "$logfile"
else
    /usr/bin/notify-send "archive backup done"
fi

/usr/bin/notify-send "dox backup started"
if ! /usr/bin/rsync --archive --checksum --partial --recursive ~/dox/ \
 -t /media/backup/ts-bak/dox \
 2>> "$logfile" \
 && /usr/bin/rsync --archive --checksum --partial --recursive /media/backup/ts-bak/dox/ \
 -t ~/dox \
 2>> "$logfile"; then
    /usr/bin/notify-send "dox backup failed" "check error log"
    /usr/bin/printf "%s\n" "dox backup for $(/usr/bin/date '+%A %F') failed at $(/usr/bin/date +%H%M)hrs" >> "$logfile"
else
    /usr/bin/notify-send "dox backup done"
fi

/usr/bin/notify-send "notx backup started"
if ! /usr/bin/rsync --archive --checksum --partial --recursive ~/notx/ \
 -t /media/backup/ts-bak/notx \
 2>> "$logfile" \
 && /usr/bin/rsync --archive --checksum --partial --recursive /media/backup/ts-bak/notx/ \
 -t ~/notx \
 2>> "$logfile"; then
    /usr/bin/notify-send "notx backup failed" "check error log"
    /usr/bin/printf "%s\n" "notx backup for $(/usr/bin/date '+%A %F') failed at $(/usr/bin/date +%H%M)hrs" >> "$logfile"
else
    /usr/bin/notify-send "notx backup done"
fi

/usr/bin/notify-send "nvl backup started"
if ! /usr/bin/rsync --archive --checksum --partial --recursive ~/nvl/ \
 -t /media/backup/ts-bak/nvl \
 2>> "$logfile" \
 && /usr/bin/rsync --archive --checksum --partial --recursive /media/backup/ts-bak/nvl/ \
 -t ~/nvl \
 2>> "$logfile"; then
    /usr/bin/notify-send "nvl backup failed" "check error log"
    /usr/bin/printf "%s\n" "nvl backup for $(/usr/bin/date '+%A %F') failed at $(/usr/bin/date +%H%M)hrs" >> "$logfile"
else
    /usr/bin/notify-send "nvl backup done"
fi

/usr/bin/notify-send "rsc backup started"
if ! /usr/bin/rsync --archive --checksum --partial --recursive ~/rsc/ \
 -t /media/backup/ts-bak/rsc \
 2>> "$logfile" \
 && /usr/bin/rsync --archive --checksum --partial --recursive /media/backup/ts-bak/rsc/ \
 -t ~/rsc \
 2>> "$logfile"; then
    /usr/bin/notify-send "rsc backup failed" "check error log"
    /usr/bin/printf "%s\n" "rsc backup for $(/usr/bin/date '+%A %F') failed at $(/usr/bin/date +%H%M)hrs" >> "$logfile"
else
    /usr/bin/notify-send "rsc backup done"
fi

/usr/bin/notify-send "sty backup started"
if ! /usr/bin/rsync --archive --checksum --partial --recursive ~/sty/ \
 -t /media/backup/ts-bak/sty \
 2>> "$logfile" \
 && /usr/bin/rsync --archive --checksum --partial --recursive /media/backup/ts-bak/sty/ \
 -t ~/sty \
 2>> "$logfile"; then
    /usr/bin/notify-send "sty backup failed" "check error log"
    /usr/bin/printf "%s\n" "sty backup for $(/usr/bin/date '+%A %F') failed at $(/usr/bin/date +%H%M)hrs" >> "$logfile"
else
    /usr/bin/notify-send "sty backup done"
fi

/usr/bin/notify-send "wfu backup started"
if ! /usr/bin/rsync --archive --checksum --partial --recursive ~/wfu/ \
 -t /media/backup/ts-bak/wfu \
 2>> "$logfile" \
 && /usr/bin/rsync --archive --checksum --partial --recursive /media/backup/ts-bak/wfu/ \
 -t ~/wfu \
 2>> "$logfile"; then
    /usr/bin/notify-send "wfu backup failed" "check error log"
    /usr/bin/printf "%s\n" "wfu backup for $(/usr/bin/date '+%A %F') failed at $(/usr/bin/date +%H%M)hrs" >> "$logfile"
else
    /usr/bin/notify-send "wfu backup done"
fi

/usr/bin/notify-send "backup complete"
/usr/bin/printf "%s\n" "backup for $(/usr/bin/date '+%A %F') completed at $(/usr/bin/date +%H%M)hrs" >> "$logfile"

# unmount backup drive
/usr/bin/pumount "$bdrive"
/usr/bin/pkill -RTMIN+14 -f /usr/local/bin/dwmblocks
/usr/bin/notify-send "backup drive unmounted"
