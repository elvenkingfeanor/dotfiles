#!/bin/sh
#bumnt
# unmount removable backup media

# make it able to handle multiple backup drives, not just 1
# logfile
logfile="$HOME/.local/share/bmnt.log"

# list attached backup drives
bdrive="$(/usr/bin/lsblk -anlp -o +LABEL | \
	/usr/bin/grep backup | \
	/usr/bin/cut -d ' ' -f 1)"

# exit if no backup drive attached
if [ -z "$bdrive" ]; then
	/usr/bin/notify-send "No backup drive attached" "Nothing to unmount"
	exit 1
fi

# if number of attached backup drives -eq 1, then bypass chooser application
if [ "$(/usr/bin/printf "%s\n" "$bdrive" | \
	/usr/bin/wc -l)" -eq 1 ]; then
	selected="$bdrive"
else
	if ! command -v dmenu > /dev/null 2>&1; then
		if command -v fzf > /dev/null 2>&1; then
			selected="$(/usr/bin/printf "%s\n" "$bdrive" | \
				fzf --prompt="choose backup drive to unmount: ")"
		else
			/usr/bin/notify-send "Error!" "Install dmenu or fzf to proceed"
			exit 1
		fi
	else
		selected="$(/usr/bin/printf "%s\n" "$bdrive" | \
			dmenu -p "choose backup drive to unmount: ")"
	fi
fi

# check if selected backup drive is mounted, then proceed accordingly
# remember to exit out of shell of drive, before unmounting
# check $(lsof "$selected") output, if any "device busy" errors encountered
# else check logfile
if [ -z "$(/usr/bin/findmnt "$selected")" ]; then
    /usr/bin/notify-send "Backup drive $selected" "not mounted"
    exit 1
else
    if ! /usr/bin/pumount "$selected" 2>> "$logfile"; then
        /usr/bin/notify-send "Backup drive $selected" "couldnot be unmounted"
        exit 1
    else
        /usr/bin/notify-send "Backup drive $selected" "unmounted successfully"
        /usr/bin/pkill -RTMIN+14 -f /usr/local/bin/dwmblocks
    fi
fi
