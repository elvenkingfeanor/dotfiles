#!/bin/sh
#umnt
# unmount removable storage device

#/usr/bin/doas /usr/bin/umount /dev/sd"$1"
# /usr/bin/pumount /dev/sd"$1"

# let's make it nicer by being interactive
log="$HOME/.local/share/mnt.log"

# check whether dmenu is present, if not check for fzf, else exit
if ! command -v dmenu > /dev/null 2>&1; then
	if command -v fzf > /dev/null 2>&1; then
	chooser="fzf"
	else
		/usr/bin/notify-send "Error!" "Install dmenu or fzf to proceed"
		exit 1
	fi
else
	chooser="dmenu"
fi

# get list of drives attached
drive="$(/usr/bin/lsblk -anlp -o +LABEL | \
    /usr/bin/grep -vE "nvme|backup" | \
    /usr/bin/grep part | \
    /usr/bin/cut -d ' ' -f 1)"

# if no removable drive attached, then exit gracefully
if [ -z "$drive" ]; then
    /usr/bin/notify-send "No drives attached" "Nothing to unmount"
    exit 1
fi

# if only 1 removable drive attached, skip chooser application
# select removable drive to unmount
if [ "$(/usr/bin/printf "%s\n" "$drive" | \
    /usr/bin/wc -l)" -eq 1 ]; then
    selected="$drive"
else
    if [ "$chooser" = "dmenu" ]; then
        selected="$(/usr/bin/printf "%s" "$drive" | \
            dmenu -p "choose device to unmount: ")"
    else
        selected="$(/usr/bin/printf "%s" "$drive" | \
            fzf --prompt="choose device to unmount: ")"
    fi
fi

# check whether selected drive is mounted, then unmount it, else exit
# remember to exit out of shell of drive, before unmounting
# check $(lsof "$drive") output, if any "device busy" errors encountered
# else check logfile
if [ -z "$(/usr/bin/findmnt "$selected")" ]; then
    /usr/bin/notify-send "$selected not mounted" "Nothing to unmount"
    exit 1
else
    if ! /usr/bin/pumount "$selected" 2>> "$log"; then
        /usr/bin/notify-send "$selected couldnot be unmounted" "check the outputs of lsof /dev/drive and logfile"
        exit 1
    else
        /usr/bin/notify-send "$selected unmounted successfully"
        /usr/bin/pkill -RTMIN+14 -f /usr/local/bin/dwmblocks
    fi
fi
